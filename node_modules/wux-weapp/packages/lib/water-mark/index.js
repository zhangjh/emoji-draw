"use strict";var _observers,_baseComponent=_interopRequireDefault(require("../helpers/baseComponent")),_classNames2=_interopRequireDefault(require("../helpers/classNames")),_styleToCssString=_interopRequireDefault(require("../helpers/styleToCssString")),_canvasPolyfill=require("../helpers/canvasPolyfill");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}(0,_baseComponent.default)({properties:{prefixCls:{type:String,value:"wux-water-mark"},content:{optionalTypes:[Array,String],type:String,value:""},fontColor:{type:String,value:"rgba(0, 0, 0, .15)"},fontStyle:{type:String,value:"normal"},fontFamily:{type:String,value:"sans-serif"},fontWeight:{type:String,value:"normal"},fontSize:{type:Number,value:14},fullPage:{type:Boolean,value:!0},gapX:{type:Number,value:24},gapY:{type:Number,value:48},width:{type:Number,value:120},height:{type:Number,value:64},image:{type:String,value:""},imageHeight:{type:Number,value:64},imageWidth:{type:Number,value:128},rotate:{type:Number,value:-22},zIndex:{type:Number,value:2e3}},data:{wrapStyle:"",base64Url:""},observers:(_observers={},_defineProperty(_observers,"zIndex, gapX, width, base64Url",function(){this.updateStyle.apply(this,arguments)}),_defineProperty(_observers,"prefixCls, gapX, gapY, rotate, fontStyle, fontWeight, width, height, fontFamily, fontColor, image, imageWidth, imageHeight, content, fontSize",function(){this.setBase64Url.apply(this,arguments)}),_observers),computed:{classes:["prefixCls, fullPage",function(e,t){return{wrap:(0,_classNames2.default)(e,_defineProperty({},"".concat(e,"--full-page"),t)),canvas:"".concat(e,"__canvas")}}]},methods:{setBase64Url:function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];var r=t[0],n=t[1],i=t[2],o=t[3],l=t[4],s=t[5],u=t[6],f=t[7],c=t[8],g=t[9],p=t[10],h=t[11],y=t[12],m=t[13],v=t[14];this.createCanvasContext({prefixCls:r,gapX:n,gapY:i,rotate:o,fontStyle:l,fontWeight:s,width:u,height:f,fontFamily:c,fontColor:g,image:p,imageWidth:h,imageHeight:y,content:m,fontSize:v})},createCanvasContext:function(t){var a=this,e=t.prefixCls,u=t.gapX,f=t.gapY,c=t.rotate,g=t.fontStyle,p=t.fontWeight,h=t.width,y=t.height,m=t.fontFamily,v=t.fontColor,r=t.image,d=t.imageWidth,b=t.imageHeight,_=t.content,S=t.fontSize,n="".concat(e,"__canvas"),i=Promise.resolve();return r&&(i=i.then(function(){return(0,_canvasPolyfill.downloadImage)(r)})),i=(i=i.then(function(e){return function(s){return(0,_canvasPolyfill.getCanvas)({canvasId:n},a).then(function(e){var a=e.getContext("2d"),t=wx.getSystemInfoSync().pixelRatio,r=(u+h)*t,n=(f+y)*t,i=h*t,o=y*t;if(e.width=r,e.height=n,s)return a.translate(i/2,o/2),a.rotate(Math.PI/180*Number(c)),(0,_canvasPolyfill.createImage)({imageWidth:d,imageHeight:b,imageUrl:s},e).then(function(){return(0,_canvasPolyfill.toDataURL)({width:h,height:y},e).then(function(e){return a.restore(),e})});if(_){a.textBaseline="middle",a.textAlign="center",a.translate(i/2,o/2),a.rotate(Math.PI/180*Number(c));var l=Number(S)*t;return a.font="".concat(g," normal ").concat(p," ").concat(l,"px/").concat(o,"px ").concat(m),a.fillStyle=v,Array.isArray(_)?_.forEach(function(e,t){return a.fillText(e,0,t*l)}):a.fillText(_,0,0),(0,_canvasPolyfill.toDataURL)({width:h,height:y},e).then(function(e){return a.restore(),e})}})}(e)})).then(function(e){!function(e){t.base64Url!==e&&(a.setData({base64Url:e}),a.triggerEvent("load",{base64Url:e}))}(e)},function(e){a.triggerEvent("error",e)})},updateStyle:function(e,t,a,r){var n=(0,_styleToCssString.default)({zIndex:e,backgroundSize:"".concat(t+a,"px"),backgroundImage:r?"url('".concat(r,"')"):"unset"});this.setData({wrapStyle:n})}},ready:function(){var e=this.data,t=e.zIndex,a=e.gapX,r=e.width,n=e.base64Url;this.updateStyle(t,a,r,n),this.createCanvasContext(this.data)}});